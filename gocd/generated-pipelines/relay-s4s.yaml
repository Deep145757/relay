{
   "format_version": 10,
   "pipelines": {
      "deploy-relay-s4s": {
         "environment_variables": {
            "GCP_PROJECT": "s4s-gcp",
            "GKE_BASTION_ZONE": "",
            "GKE_CLUSTER": "",
            "GKE_CLUSTER_ZONE": "",
            "GKE_REGION": ""
         },
         "group": "relay",
         "lock_behavior": "unlockWhenFinished",
         "materials": {
            "relay_repo": {
               "branch": "master",
               "destination": "relay",
               "git": "git@github.com:getsentry/relay.git",
               "shallow_clone": true
            },
            "upstream_pipeline": {
               "pipeline": "deploy-relay",
               "stage": "continue-pipedream"
            }
         },
         "stages": [
            {
               "checks": {
                  "approval": {
                     "type": "manual"
                  },
                  "fetch_materials": true,
                  "jobs": {
                     "checks": {
                        "elastic_profile_id": "relay",
                        "environment_variables": {
                           "GITHUB_TOKEN": "{{SECRET:[devinfra-github][token]}}"
                        },
                        "tasks": [
                           {
                              "script": "/devinfra/scripts/checks/githubactions/checkruns.py \\\n    getsentry/relay \\\n    \"${GO_REVISION_RELAY_REPO}\" \\\n    \"Integration Tests\" \\\n    \"Test (macos-latest)\" \\\n    \"Test (windows-latest)\" \\\n    \"Test All Features (ubuntu-latest)\" \\\n    \"Push GCR Docker Image\""
                           }
                        ],
                        "timeout": 1800
                     }
                  }
               }
            },
            {
               "deploy-production": {
                  "approval": {
                     "allow_only_on_success": true,
                     "type": "success"
                  },
                  "fetch_materials": true,
                  "jobs": {
                     "create_sentry_release": {
                        "elastic_profile_id": "relay",
                        "environment_variables": {
                           "SENTRY_AUTH_TOKEN": "{{SECRET:[devinfra-temp][relay_sentry_auth_token]}}",
                           "SENTRY_ORG": "sentry",
                           "SENTRY_PROJECT": "relay",
                           "SENTRY_URL": "https://sentry.my.sentry.io/"
                        },
                        "tasks": [
                           {
                              "script": "./relay/scripts/create-sentry-release \"${GO_REVISION_RELAY_REPO}\""
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy": {
                        "elastic_profile_id": "relay",
                        "tasks": [
                           {
                              "script": "/devinfra/scripts/k8s/k8stunnel && \\\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay,deploy_if_production=true\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\""
                           }
                        ],
                        "timeout": 1200
                     }
                  }
               }
            },
            {
               "continue-pipedream": {
                  "approval": {
                     "allow_only_on_success": true,
                     "type": "success"
                  },
                  "jobs": {
                     "continue": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      }
   }
}
